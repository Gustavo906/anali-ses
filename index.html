<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROSTATS APEX | Deep Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');
        :root { --bg: #050507; --panel: #111114; --accent: #3b82f6; --border: #27272a; }
        body { background-color: var(--bg); color: #e4e4e7; font-family: 'Inter', sans-serif; letter-spacing: -0.01em; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .match-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; cursor: pointer; transition: 0.2s; }
        .match-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .rank-badge { background: #1c1c21; border: 1px solid #3f3f46; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; color: #a1a1aa; }
        .divergent { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, rgba(245, 158, 11, 0.05), transparent); }
        #modal { backdrop-filter: blur(12px); }
        .progress-bar { height: 6px; background: #27272a; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="h-16 border-b border-zinc-800 bg-black px-6 flex items-center justify-between sticky top-0 z-[100]">
        <h1 class="text-sm font-black tracking-tighter uppercase text-white">PROSTATS <span class="text-blue-500">APEX</span></h1>
        <select id="leagueSelect" onchange="initApp()" class="bg-zinc-900 border border-zinc-700 text-[10px] font-bold px-4 py-2 rounded-lg text-white outline-none">
            <option value="BSA">üáßüá∑ BRASILEIR√ÉO S√âRIE A</option>
            <option value="PL">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø PREMIER LEAGUE</option>
            <option value="CL">üá™üá∫ CHAMPIONS LEAGUE (Hoje/Amanh√£)</option>
            <option value="PD">üá™üá∏ LA LIGA</option>
            <option value="SA">üáÆüáπ SERIE A</option>
        </select>
    </nav>

    <main class="flex-1 p-6 lg:p-10 max-w-7xl mx-auto w-full">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        <div id="emptyMsg" class="hidden py-40 text-center text-zinc-600 mono text-xs uppercase tracking-widest">Nenhum jogo encontrado nesta janela.</div>
    </main>

    <!-- MODAL DE AN√ÅLISE -->
    <div id="modal" class="fixed inset-0 z-[200] bg-black/95 hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-[#0d0d0f] border border-zinc-800 rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="p-6 border-b border-zinc-800 flex justify-between items-center">
                <span class="text-[10px] mono font-bold text-blue-500 uppercase tracking-widest">AI Super Analysis Terminal</span>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="p-8 lg:p-10 overflow-y-auto">
                <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-12 border-b border-zinc-800 pb-12">
                    <div class="text-center flex-1">
                        <div class="text-3xl font-black text-white italic mb-1"><span id="mPosH">--</span>¬∫</div>
                        <p class="text-[9px] uppercase font-bold text-zinc-500 mb-4">Rank Oficial</p>
                        <img id="mLogoH" class="w-16 h-16 mx-auto mb-2">
                        <h4 id="mNameH" class="text-lg font-bold uppercase text-white">--</h4>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] mono text-zinc-500 uppercase mb-2">Score Projetado</p>
                        <div id="mScore" class="text-7xl font-black italic text-white tracking-tighter">--</div>
                    </div>
                    <div class="text-center flex-1">
                        <div class="text-3xl font-black text-white italic mb-1"><span id="mPosA">--</span>¬∫</div>
                        <p class="text-[9px] uppercase font-bold text-zinc-500 mb-4">Rank Oficial</p>
                        <img id="mLogoA" class="w-16 h-16 mx-auto mb-2">
                        <h4 id="mNameA" class="text-lg font-bold uppercase text-white">--</h4>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="space-y-6">
                        <h5 class="text-xs font-bold text-zinc-500 uppercase flex items-center gap-2"><i class="fa-solid fa-brain text-blue-500"></i> Insight do Especialista IA</h5>
                        <div class="bg-blue-600/5 border-l-4 border-blue-600 p-6 rounded-r-xl text-base italic text-zinc-200 leading-relaxed" id="mAnalysis">Carregando an√°lise...</div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="bg-zinc-900 p-3 rounded-lg text-center">
                                <span class="text-[9px] text-zinc-500 block">WIN CASA</span>
                                <span id="mProbH" class="text-sm font-bold text-blue-500">0%</span>
                            </div>
                            <div class="bg-zinc-900 p-3 rounded-lg text-center">
                                <span class="text-[9px] text-zinc-500 block">EMPATE</span>
                                <span id="mProbD" class="text-sm font-bold text-zinc-500">0%</span>
                            </div>
                            <div class="bg-zinc-900 p-3 rounded-lg text-center">
                                <span class="text-[9px] text-zinc-500 block">WIN FORA</span>
                                <span id="mProbA" class="text-sm font-bold text-white">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/40 p-6 rounded-2xl border border-zinc-800 space-y-4">
                        <h5 class="text-xs font-bold text-zinc-500 uppercase mb-4">M√©tricas de Probabilidade</h5>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Chance Over 2.5 Gols</span><span id="mOver" class="font-bold">0%</span></div>
                            <div class="progress-bar"><div id="mBarOver" class="progress-fill bg-blue-600" style="width: 0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Ambas Marcam (BTTS)</span><span id="mBtts" class="font-bold">0%</span></div>
                            <div class="progress-bar"><div id="mBarBtts" class="progress-fill bg-emerald-500" style="width: 0%"></div></div>
                        </div>
                        <div class="pt-4 flex justify-between items-center border-t border-zinc-800">
                            <span class="text-[10px] uppercase text-zinc-500">Expectativa xG Total:</span>
                            <span id="mTotalXG" class="text-xl font-black text-blue-500">0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '8e3c0eba984c46a090a5c53c37835285';
        const PROXY = "https://corsproxy.io/?";
        let store = { table: [], matches: [], avg: 0 };

        async function initApp() {
            const league = document.getElementById('leagueSelect').value;
            const grid = document.getElementById('grid');
            grid.innerHTML = `<div class="col-span-full py-20 text-center mono text-[10px] animate-pulse">SINCRONIZANDO DADOS NACIONAIS...</div>`;

            try {
                const [resS, resM] = await Promise.all([
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/standings`, { headers: {'X-Auth-Token': API_KEY}}),
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/matches?status=SCHEDULED`, { headers: {'X-Auth-Token': API_KEY}})
                ]);

                const sD = await resS.json();
                const mD = await resM.json();

                // L√≥gica de Tabela (Champions vs Outras)
                if (league === 'CL') {
                    store.table = [];
                    sD.standings.forEach(grp => grp.table.forEach(team => { team.group = grp.group; store.table.push(team); }));
                } else {
                    store.table = sD.standings[0].table;
                }

                // M√©dia de Gols
                let goals = 0, games = 0;
                store.table.forEach(t => { goals += t.goalsFor; games += t.playedGames; });
                store.avg = goals / (games || 1);

                // Filtro solicitado
                const now = new Date();
                const limit = new Date();
                const windowHours = (league === 'CL') ? 48 : 120; // 48h para Champions, 5 dias para o resto
                limit.setHours(now.getHours() + windowHours);

                const valid = mD.matches.filter(m => {
                    const d = new Date(m.utcDate);
                    return d >= now && d <= limit;
                });

                if (valid.length === 0) {
                    grid.innerHTML = "";
                    document.getElementById('emptyMsg').classList.remove('hidden');
                    return;
                }

                document.getElementById('emptyMsg').classList.add('hidden');
                grid.innerHTML = valid.map(m => {
                    const h = store.table.find(t => t.team.id === m.homeTeam.id);
                    const a = store.table.find(t => t.team.id === m.awayTeam.id);
                    const isDiv = a && h && (a.position < h.position - 6);

                    return `
                    <div onclick="runAnalysis(${m.homeTeam.id}, ${m.awayTeam.id})" class="match-card ${isDiv ? 'divergent' : ''}">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[9px] mono text-zinc-500">${new Date(m.utcDate).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                            <div class="flex gap-2">
                                <span class="rank-badge">CASA: ${h ? h.position : '?'}¬∫</span>
                                <span class="rank-badge">FORA: ${a ? a.position : '?'}¬∫</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <img src="${m.homeTeam.crest}" class="w-5 h-5 object-contain">
                                <span class="text-sm font-bold uppercase text-white">${m.homeTeam.shortName}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <img src="${m.awayTeam.crest}" class="w-5 h-5 object-contain">
                                <span class="text-sm font-bold uppercase text-white">${m.awayTeam.shortName}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');

            } catch (e) {
                grid.innerHTML = `<div class="col-span-full py-10 text-red-500 text-center mono uppercase text-xs">Erro: Limite de API ou Conex√£o.</div>`;
            }
        }

        function factorial(n) { return (n <= 1) ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / Math.exp(Math.log(factorial(k))); }

        function runAnalysis(hId, aId) {
            const h = store.table.find(t => t.team.id === hId);
            const a = store.table.find(t => t.team.id === aId);
            if(!h || !a) return;

            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // C√°lculo xG Realista
            const hAtk = (h.goalsFor / (h.playedGames || 1)) / store.avg;
            const hDef = (h.goalsAgainst / (h.playedGames || 1)) / store.avg;
            const aAtk = (a.goalsFor / (a.playedGames || 1)) / store.avg;
            const aDef = (a.goalsAgainst / (a.playedGames || 1)) / store.avg;

            const xGH = hAtk * aDef * store.avg * 1.15;
            const xGA = aAtk * hDef * store.avg;

            let probH = 0, probD = 0, probA = 0, over25 = 0, btts = 0, maxP = 0, bestS = "";

            for(let i=0; i<6; i++) {
                for(let j=0; j<6; j++) {
                    const p = (Math.pow(xGH, i) * Math.exp(-xGH) / factorial(i)) * (Math.pow(xGA, j) * Math.exp(-xGA) / factorial(j));
                    if(i > j) probH += p; else if(i === j) probD += p; else probA += p;
                    if(i + j > 2.5) over25 += p;
                    if(i > 0 && j > 0) btts += p;
                    if(p > maxP) { maxP = p; bestS = `${i} - ${j}`; }
                }
            }

            // Atualiza√ß√£o do Modal
            document.getElementById('mLogoH').src = h.team.crest;
            document.getElementById('mLogoA').src = a.team.crest;
            document.getElementById('mNameH').innerText = h.team.shortName;
            document.getElementById('mNameA').innerText = a.team.shortName;
            document.getElementById('mPosH').innerText = h.position;
            document.getElementById('mPosA').innerText = a.position;
            document.getElementById('mScore').innerText = bestS;
            
            document.getElementById('mProbH').innerText = (probH * 100).toFixed(1) + '%';
            document.getElementById('mProbD').innerText = (probD * 100).toFixed(1) + '%';
            document.getElementById('mProbA').innerText = (probA * 100).toFixed(1) + '%';
            
            document.getElementById('mOver').innerText = (over25 * 100).toFixed(1) + '%';
            document.getElementById('mBtts').innerText = (btts * 100).toFixed(1) + '%';
            document.getElementById('mBarOver').style.width = (over25 * 100) + '%';
            document.getElementById('mBarBtts').style.width = (btts * 100) + '%';
            document.getElementById('mTotalXG').innerText = (xGH + xGA).toFixed(2);

            // An√°lise Heur√≠stica
            const diff = h.position - a.position;
            let n = "";
            if (probH > 0.55 && diff > 5) {
                n = `OPORTUNIDADE DETECTADA: O ${h.team.shortName} est√° abaixo no Rank (${h.position}¬∫), mas sua efici√™ncia de gols em casa √© superior. A IA detecta valor em contrariar a tabela nacional aqui.`;
            } else if (probH > 0.65) {
                n = `DOM√çNIO CONFIRMADO: O mandante possui uma expectativa de ${(xGH).toFixed(1)} gols contra a defesa vulner√°vel do visitante. Favoritismo estat√≠stico consolidado.`;
            } else if (over25 > 0.60) {
                n = `CEN√ÅRIO DE OVER: Ambas as defesas cedem espa√ßo significativo. A matriz de Poisson aponta alta probabilidade de rede balan√ßando para os dois lados.`;
            } else {
                n = `EQUIL√çBRIO T√ÅTICO: As posi√ß√µes ${h.position}¬∫ e ${a.position}¬∫ refletem um jogo de xG baixo. O empate em ${(probD*100).toFixed(0)}% tem um peso maior do que o mercado de apostas sugere.`;
            }
            document.getElementById('mAnalysis').innerText = n;
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        window.onload = initApp;
    </script>
</body>
</html>
