<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROSTATS APEX | Elite Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --bg: #09090b;
            --surface: #121217;
            --border: #27272a;
            --accent: #3b82f6;
            --success: #10b981;
        }

        body {
            background-color: var(--bg);
            color: #f4f4f5;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Estilo Dashboard Profissional */
        .glass-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            border-color: #3f3f46;
            background: #16161d;
        }

        /* Badge de Posição */
        .pos-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 99px;
            color: #a1a1aa;
        }

        /* Barras de Probabilidade Smooth */
        .prob-container {
            height: 8px;
            background: #27272a;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }
        .prob-segment { transition: width 1s ease-in-out; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }

        .analysis-text {
            line-height: 1.7;
            font-size: 0.925rem;
            color: #d4d4d8;
        }

        /* Efeito de carregamento */
        .loading-shimmer {
            background: linear-gradient(90deg, #121217 25%, #1c1c24 50%, #121217 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- TOP NAVIGATION BAR -->
    <nav class="h-16 border-b border-zinc-800 bg-zinc-950/50 backdrop-blur-md px-6 flex items-center justify-between sticky top-0 z-[100]">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/20">
                    <i class="fa-solid fa-chart-simple text-white text-sm"></i>
                </div>
                <h1 class="text-sm font-extrabold tracking-tighter uppercase">ProStats <span class="text-blue-500">Apex</span></h1>
            </div>
            <div class="h-4 w-[1px] bg-zinc-800 hidden md:block"></div>
            <div class="hidden md:flex items-center gap-4 text-[10px] mono text-zinc-500 font-bold uppercase tracking-widest">
                <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Data Stream: Active</span>
                <span class="flex items-center gap-1.5">Window: 48 Hours</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <select id="leagueSelect" onchange="fetchData()" class="bg-zinc-900 border border-zinc-800 text-[10px] font-bold px-4 py-2 rounded-lg outline-none focus:ring-1 ring-blue-500 text-zinc-300">
                <option value="CL">Champions League</option>
                <option value="PL">Premier League</option>
                <option value="BSA">Brasileirão Série A</option>
                <option value="PD">La Liga</option>
                <option value="SA">Serie A</option>
            </select>
        </div>
    </nav>

    <!-- DASHBOARD CONTENT -->
    <main class="flex-1 p-6 lg:p-10 max-w-[1400px] mx-auto w-full">
        <header class="mb-10">
            <h2 class="text-3xl font-extrabold tracking-tight mb-2">Painel de Decisão Técnica</h2>
            <p class="text-zinc-500 text-sm max-w-2xl">Mapeamento algorítmico de confrontos baseado em matrizes de Poisson e regressão de classificação.</p>
        </header>

        <!-- GRID DE JOGOS -->
        <div id="matchesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Cards injetados -->
        </div>

        <div id="emptyState" class="hidden py-32 text-center">
            <div class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-4 border border-zinc-800">
                <i class="fa-solid fa-calendar-day text-zinc-600"></i>
            </div>
            <p class="mono text-xs text-zinc-500 uppercase tracking-widest">Sem eventos programados para o intervalo de 48h</p>
        </div>
    </main>

    <!-- MODAL DE ANÁLISE DE PROFUNDIDADE -->
    <div id="modal" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-[#121217] border border-zinc-800 rounded-2xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden">
            
            <div class="p-6 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/30">
                <div class="flex items-center gap-4">
                    <span class="text-[10px] mono font-bold bg-blue-600/10 text-blue-500 px-3 py-1 rounded border border-blue-600/20 uppercase tracking-widest">Relatório Deep Insights</span>
                    <span id="mDate" class="text-[10px] mono text-zinc-500"></span>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-800 text-zinc-400"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 lg:p-12">
                <!-- VERSUS HEADER -->
                <div class="flex flex-col md:flex-row items-center justify-between gap-10 mb-16 border-b border-zinc-800 pb-16">
                    <div class="text-center flex-1">
                        <div class="pos-badge mb-4 inline-block"><span id="mPosH">--</span>º Lugar</div>
                        <img id="mLogoH" class="w-24 h-24 mx-auto mb-6 drop-shadow-2xl">
                        <h4 id="mNameH" class="text-2xl font-black uppercase tracking-tighter">--</h4>
                    </div>

                    <div class="text-center px-10">
                        <div class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2">Placar Projetado</div>
                        <div id="mScore" class="text-8xl font-black italic tracking-tighter text-white">--</div>
                        <div id="mConf" class="mt-4 text-[10px] font-bold text-emerald-500 mono bg-emerald-500/5 py-1 px-4 rounded-full inline-block">--</div>
                    </div>

                    <div class="text-center flex-1">
                        <div class="pos-badge mb-4 inline-block"><span id="mPosA">--</span>º Lugar</div>
                        <img id="mLogoA" class="w-24 h-24 mx-auto mb-6 drop-shadow-2xl">
                        <h4 id="mNameA" class="text-2xl font-black uppercase tracking-tighter">--</h4>
                    </div>
                </div>

                <!-- ANALYTICS CONTENT -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    
                    <!-- IA SUPER ANALYSIS (LEFT 2/3) -->
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-blue-600/5 border-l-4 border-blue-600 p-8 rounded-r-2xl">
                            <h5 class="text-blue-500 font-bold text-xs uppercase mono mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-microchip"></i> Análise Heurística da IA
                            </h5>
                            <p id="mAnalysis" class="analysis-text italic"></p>
                        </div>

                        <!-- Probabilidades Visuais -->
                        <div class="space-y-6">
                            <h5 class="text-zinc-500 font-bold text-[10px] uppercase mono tracking-widest">Distribuição de Probabilidade (ML)</h5>
                            <div class="prob-container">
                                <div id="mBarH" class="prob-segment bg-blue-600 h-full" style="width: 33%"></div>
                                <div id="mBarD" class="prob-segment bg-zinc-600 h-full" style="width: 33%"></div>
                                <div id="mBarA" class="prob-segment bg-white h-full" style="width: 34%"></div>
                            </div>
                            <div class="grid grid-cols-3 text-center">
                                <div><span class="text-[10px] text-zinc-500 block uppercase">Casa</span><span id="mProbH" class="font-bold text-blue-500">0%</span></div>
                                <div><span class="text-[10px] text-zinc-500 block uppercase">Empate</span><span id="mProbD" class="font-bold text-zinc-400">0%</span></div>
                                <div><span class="text-[10px] text-zinc-500 block uppercase">Fora</span><span id="mProbA" class="font-bold text-white">0%</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- METRICS SIDEBAR (RIGHT 1/3) -->
                    <div class="space-y-4">
                        <div class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800">
                            <h6 class="text-[10px] font-bold text-zinc-500 uppercase mb-4">Métricas de Jogo</h6>
                            <div class="space-y-4">
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-zinc-400 uppercase">Prob. Over 2.5</span>
                                    <span id="mOver" class="text-lg font-bold mono">0%</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-zinc-400 uppercase">Ambas Marcam</span>
                                    <span id="mBtts" class="text-lg font-bold mono">0%</span>
                                </div>
                                <div class="h-[1px] bg-zinc-800 my-2"></div>
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-zinc-400 uppercase">Diferença de Rank</span>
                                    <span id="mRankDiff" class="text-lg font-bold mono">--</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <span class="text-xs text-zinc-400 uppercase text-blue-500">Valor Esperado (xG)</span>
                                    <span id="mTotalXG" class="text-lg font-bold mono text-blue-500">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '8e3c0eba984c46a090a5c53c37835285';
        const PROXY = "https://corsproxy.io/?";
        let engine = { table: [], avgGoals: 0 };

        async function fetchData() {
            const league = document.getElementById('leagueSelect').value;
            const grid = document.getElementById('matchesGrid');
            const empty = document.getElementById('emptyState');
            
            grid.innerHTML = `<div class="col-span-full h-40 flex flex-col items-center justify-center gap-4">
                <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="mono text-[10px] text-zinc-500 uppercase tracking-widest">Sincronizando Datacenter...</span>
            </div>`;
            empty.classList.add('hidden');

            try {
                const [resS, resM] = await Promise.all([
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/standings`, { headers: {'X-Auth-Token': API_KEY}}),
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/matches?status=SCHEDULED`, { headers: {'X-Auth-Token': API_KEY}})
                ]);

                const sD = await resS.json();
                const mD = await resM.json();

                engine.table = sD.standings[0].table;
                
                // Média Dinâmica da Liga
                let tg = 0, tj = 0;
                engine.table.forEach(t => { tg += t.goalsFor; tj += t.playedGames; });
                engine.avgGoals = tg / tj;

                // Filtro 48h (Hoje e Amanhã)
                const now = new Date();
                const limit = new Date();
                limit.setHours(now.getHours() + 48);

                const validMatches = mD.matches.filter(m => {
                    const matchDate = new Date(m.utcDate);
                    return matchDate >= now && matchDate <= limit;
                });

                if(validMatches.length === 0) {
                    grid.innerHTML = "";
                    empty.classList.remove('hidden');
                    return;
                }

                grid.innerHTML = validMatches.map(m => {
                    const h = engine.table.find(t => t.team.id === m.homeTeam.id);
                    const a = engine.table.find(t => t.team.id === m.awayTeam.id);
                    const d = new Date(m.utcDate);
                    
                    return `
                    <div onclick="runDeepAnalysis(${m.homeTeam.id}, ${m.awayTeam.id}, '${m.utcDate}')" class="glass-card p-6 cursor-pointer relative overflow-hidden group">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] mono font-bold text-zinc-500">${d.toLocaleDateString('pt-BR')} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}</span>
                            <div class="flex gap-1.5">
                                <span class="pos-badge">${h ? h.position : '?'}/º</span>
                                <span class="pos-badge border-blue-500/20 text-blue-400">${a ? a.position : '?'}/º</span>
                            </div>
                        </div>
                        <div class="space-y-4 mb-4">
                            <div class="flex items-center gap-3">
                                <img src="${m.homeTeam.crest}" class="w-6 h-6 object-contain">
                                <span class="text-sm font-bold uppercase tracking-tight truncate">${m.homeTeam.shortName}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <img src="${m.awayTeam.crest}" class="w-6 h-6 object-contain">
                                <span class="text-sm font-bold uppercase tracking-tight truncate">${m.awayTeam.shortName}</span>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-zinc-800 flex justify-between items-center">
                            <span class="text-[9px] mono font-bold text-blue-500 uppercase">Processar Insights</span>
                            <i class="fa-solid fa-chevron-right text-zinc-700 text-[10px] group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </div>`;
                }).join('');

            } catch (e) {
                grid.innerHTML = `<div class="col-span-full p-10 bg-red-900/10 border border-red-900/20 rounded-2xl text-center text-red-500 mono text-xs uppercase tracking-widest">Rate Limit da API atingido. Aguarde 60 segundos.</div>`;
            }
        }

        // MOTOR POISSON BAYESIANO
        function factorial(n) { return (n <= 1) ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

        function runDeepAnalysis(hId, aId, dateStr) {
            const h = engine.table.find(t => t.team.id === hId);
            const a = engine.table.find(t => t.team.id === aId);
            if(!h || !a) return;

            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            document.getElementById('mDate').innerText = new Date(dateStr).toLocaleString('pt-BR');

            // Poisson Calculation
            const hAtk = (h.goalsFor / h.playedGames) / engine.avgGoals;
            const hDef = (h.goalsAgainst / h.playedGames) / engine.avgGoals;
            const aAtk = (a.goalsFor / a.playedGames) / engine.avgGoals;
            const aDef = (a.goalsAgainst / a.playedGames) / engine.avgGoals;

            // Ajuste Vantagem Campo (15%)
            const xGH = hAtk * aDef * engine.avgGoals * 1.15;
            const xGA = aAtk * hDef * engine.avgGoals;

            let probH = 0, probD = 0, probA = 0, over2 = 0, btts = 0, maxP = 0, bestS = "";

            for(let i=0; i<6; i++) {
                for(let j=0; j<6; j++) {
                    const p = poisson(i, xGH) * poisson(j, xGA);
                    if(i > j) probH += p; else if(i === j) probD += p; else probA += p;
                    if(i + j > 2.5) over2 += p;
                    if(i > 0 && j > 0) btts += p;
                    if(p > maxP) { maxP = p; bestS = `${i} - ${j}`; }
                }
            }

            // Atualização da UI (Cores preservadas)
            document.getElementById('mLogoH').src = h.team.crest;
            document.getElementById('mLogoA').src = a.team.crest;
            document.getElementById('mNameH').innerText = h.team.shortName;
            document.getElementById('mNameA').innerText = a.team.shortName;
            document.getElementById('mPosH').innerText = h.position;
            document.getElementById('mPosA').innerText = a.position;
            document.getElementById('mScore').innerText = bestS;
            document.getElementById('mConf').innerText = `CONFIANÇA: ${(maxP * 100).toFixed(1)}%`;
            
            document.getElementById('mProbH').innerText = (probH * 100).toFixed(1) + '%';
            document.getElementById('mProbD').innerText = (probD * 100).toFixed(1) + '%';
            document.getElementById('mProbA').innerText = (probA * 100).toFixed(1) + '%';
            
            document.getElementById('mBarH').style.width = (probH * 100) + '%';
            document.getElementById('mBarD').style.width = (probD * 100) + '%';
            document.getElementById('mBarA').style.width = (probA * 100) + '%';

            document.getElementById('mOver').innerText = (over2 * 100).toFixed(0) + '%';
            document.getElementById('mBtts').innerText = (btts * 100).toFixed(0) + '%';
            document.getElementById('mRankDiff').innerText = Math.abs(h.position - a.position);
            document.getElementById('mTotalXG').innerText = (xGH + xGA).toFixed(2);

            // GERAÇÃO DE ANÁLISE PROFUNDA (Não genérica)
            generateDeepAnalysis(h, a, probH, probA, xGH, xGA);
        }

        function generateDeepAnalysis(h, a, pH, pA, xGH, xGA) {
            let n = "";
            const diff = h.position - a.position;

            if (Math.abs(diff) > 10) {
                const fav = diff < 0 ? h.team.shortName : a.team.shortName;
                n = `DISPARIDADE TÉCNICA CLARA: O ${fav} opera em um patamar de eficiência ${(xGH > xGA ? xGH/xGA : xGA/xGH).toFixed(1)}x superior. A análise quantitativa sugere que a posição na tabela reflete fielmente o volume de jogo. Não identificamos cenários de alta probabilidade para 'zebra'.`;
            } else if (pH > 0.55) {
                n = `VANTAGEM ESTRUTURAL: O ${h.team.shortName} possui um diferencial de xG de ${(xGH - xGA).toFixed(2)} em relação ao oponente. O modelo identifica que o fator campo será decisivo para romper o bloqueio defensivo do ${a.team.shortName}, que costuma ceder mais gols contra ataques de elite.`;
            } else if (xGH + xGA > 3.0) {
                n = `CENÁRIO DE VOLATILIDADE: Ambos os times possuem defesas vulneráveis mas ataques explosivos. Com um xG Total de ${(xGH+xGA).toFixed(2)}, esperamos uma partida aberta onde as linhas de handicap perdem valor frente ao mercado de gols (Over).`;
            } else {
                n = `CONFRONTO EQUILIBRADO: Separados por apenas ${Math.abs(diff)} posições, os dados indicam um jogo de xG baixo (${(xGH+xGA).toFixed(2)}). O empate tem uma probabilidade matemática de ${(33).toFixed(0)}%, o que é significativamente alto para este mercado.`;
            }

            document.getElementById('mAnalysis').innerText = n;
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        window.onload = fetchData;
    </script>
</body>
</html>
